name: ðŸ” Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================
  # PR VALIDATION
  # ===========================================
  pr-validation:
    name: ðŸ” PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ðŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install ruff mypy pytest pytest-cov pytest-mock
        
    - name: ðŸ” Run linting
      run: |
        echo "ðŸ” Running linting checks..."
        ruff check src/ tests/ dags/ scripts/ --output-format=github
        
    - name: ðŸŽ¨ Check formatting
      run: |
        echo "ðŸŽ¨ Checking code formatting..."
        ruff format --check src/ tests/ dags/ scripts/
        
    - name: ðŸ”¬ Run type checking
      run: |
        echo "ðŸ”¬ Running type checking..."
        mypy src/ --ignore-missing-imports --no-error-summary

  # ===========================================
  # QUICK TESTS
  # ===========================================
  quick-tests:
    name: âš¡ Quick Tests
    runs-on: ubuntu-latest
    needs: pr-validation
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ðŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install pytest pytest-cov pytest-mock
        
    - name: âš¡ Run quick unit tests
      run: |
        echo "âš¡ Running quick unit tests..."
        python -m pytest tests/pipelines/data_science/test_pipeline.py -v --tb=short
        
    - name: ðŸ§ª Run validation scripts
      run: |
        echo "ðŸ§ª Running validation scripts..."
        python scripts/validate_dag_structure.py

  # ===========================================
  # DOCKER BUILD TEST
  # ===========================================
  docker-build-test:
    name: ðŸ³ Docker Build Test
    runs-on: ubuntu-latest
    needs: pr-validation
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ðŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        
    - name: ðŸ³ Build Kedro Docker image
      run: |
        echo "ðŸ³ Building Kedro Docker image..."
        docker build -f docker/Dockerfile.kedro -t spaceflights-kedro:pr-test .
        
    - name: ðŸ³ Test Kedro container
      run: |
        echo "ðŸ§ª Testing Kedro container..."
        docker run --rm spaceflights-kedro:pr-test kedro info
        
    - name: ðŸ³ Build Airflow Docker image
      run: |
        echo "ðŸ³ Building Airflow Docker image..."
        docker build -f docker/Dockerfile.airflow -t spaceflights-airflow:pr-test .
        
    - name: ðŸ³ Test Airflow container
      run: |
        echo "ðŸ§ª Testing Airflow container..."
        docker run --rm spaceflights-airflow:pr-test airflow version

  # ===========================================
  # PR SUMMARY
  # ===========================================
  pr-summary:
    name: ðŸ“‹ PR Summary
    runs-on: ubuntu-latest
    needs: [pr-validation, quick-tests, docker-build-test]
    if: always()
    
    steps:
    - name: ðŸ“‹ Create PR summary
      run: |
        echo "ðŸ“‹ Creating PR summary..."
        
        # Create summary file
        cat > pr-summary.md << EOF
        # ðŸ” Pull Request Validation Summary
        
        ## âœ… Validation Results
        
        - **Code Quality**: ${{ needs.pr-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
        - **Quick Tests**: ${{ needs.quick-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
        - **Docker Build**: ${{ needs.docker-build-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
        
        ## ðŸ“Š Overall Status
        
        ${{ needs.pr-validation.result == 'success' && needs.quick-tests.result == 'success' && needs.docker-build-test.result == 'success' && 'ðŸŽ‰ **All checks passed!** This PR is ready for review.' || 'âš ï¸ **Some checks failed.** Please review the logs and fix the issues before merging.' }}
        
        ## ðŸ” What was tested
        
        - Code linting and formatting
        - Type checking
        - Unit tests
        - Docker image builds
        - Container functionality
        
        ## ðŸ“ Next Steps
        
        ${{ needs.pr-validation.result == 'success' && needs.quick-tests.result == 'success' && needs.docker-build-test.result == 'success' && '1. âœ… All validations passed' || '1. âŒ Fix the failing checks above' }}
        ${{ needs.pr-validation.result == 'success' && needs.quick-tests.result == 'success' && needs.docker-build-test.result == 'success' && '2. ðŸ” Ready for code review' || '2. ðŸ” Review the error logs' }}
        ${{ needs.pr-validation.result == 'success' && needs.quick-tests.result == 'success' && needs.docker-build-test.result == 'success' && '3. ðŸš€ Can be merged to main' || '3. ðŸ”§ Fix issues and re-run checks' }}
        
        EOF
        
        # Display summary
        cat pr-summary.md
        
    - name: ðŸ“‹ Upload PR summary
      uses: actions/upload-artifact@v4
      with:
        name: pr-summary
        path: pr-summary.md
        
    - name: ðŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('pr-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
