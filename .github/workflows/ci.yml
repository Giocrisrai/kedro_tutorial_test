name: ğŸš€ Spaceflights CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Permite ejecutar manualmente

env:
  PYTHON_VERSION: '3.11'
  KEDRO_ENV: 'base'

jobs:
  # ===========================================
  # LINTING AND CODE QUALITY
  # ===========================================
  lint-and-format:
    name: ğŸ” Linting & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ğŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install ruff mypy pytest pytest-cov pytest-mock
        
    - name: ğŸ” Run linting with ruff
      run: |
        echo "ğŸ” Running ruff linting..."
        ruff check src/ tests/ dags/ scripts/ --output-format=github
        
    - name: ğŸ¨ Check code formatting
      run: |
        echo "ğŸ¨ Checking code formatting..."
        ruff format --check src/ tests/ dags/ scripts/
        
    - name: ğŸ”¬ Run type checking with mypy
      run: |
        echo "ğŸ”¬ Running type checking..."
        mypy src/ --ignore-missing-imports --no-error-summary

  # ===========================================
  # UNIT TESTS
  # ===========================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-format
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ğŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install pytest pytest-cov pytest-mock
        
    - name: ğŸ§ª Run unit tests
      run: |
        echo "ğŸ§ª Running unit tests..."
        python -m pytest tests/pipelines/ -m unit -v --cov=src/spaceflights --cov-report=xml --cov-report=term-missing
        
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # ===========================================
  # INTEGRATION TESTS
  # ===========================================
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: lint-and-format
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ğŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install pytest pytest-cov pytest-mock
        
    - name: ğŸ”— Run integration tests
      run: |
        echo "ğŸ”— Running integration tests..."
        python -m pytest tests/integration/ -m integration -v --tb=short
        
    - name: ğŸ§ª Run Kedro pipeline tests
      run: |
        echo "ğŸ§ª Testing Kedro pipelines..."
        python scripts/validate_advanced_ml.py

  # ===========================================
  # FUNCTIONAL TESTS
  # ===========================================
  functional-tests:
    name: âš™ï¸ Functional Tests
    runs-on: ubuntu-latest
    needs: lint-and-format
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ğŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install pytest pytest-cov pytest-mock
        
    - name: âš™ï¸ Run functional tests
      run: |
        echo "âš™ï¸ Running functional tests..."
        python -m pytest tests/dags/ -m functional -v --tb=short
        
    - name: ğŸ” Validate DAG structure
      run: |
        echo "ğŸ” Validating DAG structure..."
        python scripts/validate_dag_structure.py

  # ===========================================
  # DOCKER TESTS
  # ===========================================
  docker-tests:
    name: ğŸ³ Docker Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, functional-tests]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ğŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        
    - name: ğŸ³ Build Kedro Docker image
      run: |
        echo "ğŸ³ Building Kedro Docker image..."
        docker build -f docker/Dockerfile.kedro -t spaceflights-kedro:test .
        
    - name: ğŸ³ Test Kedro container
      run: |
        echo "ğŸ§ª Testing Kedro container..."
        docker run --rm spaceflights-kedro:test kedro info
        
    - name: ğŸ³ Test Kedro pipeline execution
      run: |
        echo "ğŸ§ª Testing Kedro pipeline execution..."
        docker run --rm spaceflights-kedro:test kedro run --pipeline data_processing
        
    - name: ğŸ³ Build Airflow Docker image
      run: |
        echo "ğŸ³ Building Airflow Docker image..."
        docker build -f docker/Dockerfile.airflow -t spaceflights-airflow:test .
        
    - name: ğŸ³ Test Airflow container
      run: |
        echo "ğŸ§ª Testing Airflow container..."
        docker run --rm spaceflights-airflow:test airflow version

  # ===========================================
  # END-TO-END TESTS
  # ===========================================
  e2e-tests:
    name: ğŸ¯ End-to-End Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, functional-tests]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ğŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install pytest pytest-cov pytest-mock
        
    - name: ğŸ¯ Run end-to-end tests
      run: |
        echo "ğŸ¯ Running end-to-end tests..."
        python -m pytest tests/integration/test_integration.py::TestDataIntegration::test_end_to_end_pipeline_integration -v
        
    - name: ğŸ§ª Run comprehensive validation
      run: |
        echo "ğŸ§ª Running comprehensive validation..."
        python scripts/run_tests.py --type validation

  # ===========================================
  # SECURITY SCAN
  # ===========================================
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ğŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        uv pip install safety bandit
        
    - name: ğŸ”’ Run security scan with safety
      run: |
        echo "ğŸ”’ Running security scan..."
        safety check --json --output safety-report.json || true
        
    - name: ğŸ”’ Run bandit security scan
      run: |
        echo "ğŸ”’ Running bandit security scan..."
        bandit -r src/ -f json -o bandit-report.json || true

  # ===========================================
  # FINAL VALIDATION
  # ===========================================
  final-validation:
    name: âœ… Final Validation
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, functional-tests, docker-tests, e2e-tests, security-scan]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: ğŸ“¦ Install dependencies
      run: |
        uv pip install --upgrade pip
        uv pip install -r requirements.txt
        
    - name: âœ… Run final validation
      run: |
        echo "âœ… Running final validation..."
        python scripts/run_tests.py --type all
        
    - name: ğŸ“Š Generate test report
      run: |
        echo "ğŸ“Š Generating test report..."
        echo "# ğŸš€ Spaceflights CI/CD Test Report" > test-report.md
        echo "" >> test-report.md
        echo "## Test Results" >> test-report.md
        echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> test-report.md
        echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> test-report.md
        echo "- Functional Tests: ${{ needs.functional-tests.result }}" >> test-report.md
        echo "- Docker Tests: ${{ needs.docker-tests.result }}" >> test-report.md
        echo "- End-to-End Tests: ${{ needs.e2e-tests.result }}" >> test-report.md
        echo "- Security Scan: ${{ needs.security-scan.result }}" >> test-report.md
        echo "" >> test-report.md
        echo "## Summary" >> test-report.md
        echo "All tests completed successfully! ğŸ‰" >> test-report.md
        
    - name: ğŸ“‹ Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: test-report.md
        
    - name: ğŸ‰ Success notification
      if: success()
      run: |
        echo "ğŸ‰ All tests passed successfully!"
        echo "âœ… Code quality checks passed"
        echo "âœ… Unit tests passed"
        echo "âœ… Integration tests passed"
        echo "âœ… Functional tests passed"
        echo "âœ… Docker tests passed"
        echo "âœ… End-to-end tests passed"
        echo "âœ… Security scan completed"
        echo ""
        echo "ğŸš€ The Spaceflights project is ready for deployment!"
        
    - name: âŒ Failure notification
      if: failure()
      run: |
        echo "âŒ Some tests failed!"
        echo "Please check the logs above for details."
        echo ""
        echo "ğŸ” Failed jobs:"
        echo "- Linting: ${{ needs.lint-and-format.result }}"
        echo "- Unit Tests: ${{ needs.unit-tests.result }}"
        echo "- Integration Tests: ${{ needs.integration-tests.result }}"
        echo "- Functional Tests: ${{ needs.functional-tests.result }}"
        echo "- Docker Tests: ${{ needs.docker-tests.result }}"
        echo "- End-to-End Tests: ${{ needs.e2e-tests.result }}"
        echo "- Security Scan: ${{ needs.security-scan.result }}"
